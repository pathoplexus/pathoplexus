import{j as e}from"./jsx-runtime.C9E4cUVc.js";import{u as S,a as D,c as O,A as v}from"./createAuthorizationHeader.D0lXW5f5.js";import{r as w}from"./index.BOC3FD3Q.js";import{y as I}from"./_astro-entry_react-toastify.w1t6keWD.js";import{CitationPlot as C}from"./CitationPlot.LzN6PNqO.js";import{S as A,s as $}from"./serviceHooks.qDjWrls6.js";import{g as P}from"./clientLogger.CHIvnBnE.js";import{d as q}from"./ConfirmationDialog.DES7BW3S.js";import{w as M}from"./withQueryProvider.C5jGp74p.js";import{P as k}from"./Pagination.BSeKhfNm.js";import"./lapis.BMBLPoxt.js";import"./clsx.B-dksMZM.js";import"./index.B4z6aONy.js";import"./client.DPyJZckk.js";import"./index.BDobkqVR.js";import"./useTheme.DwRJctbP.js";import"./ButtonBase.BnBxMrJ6.js";const E=async(i,x,t)=>{const n=i.map(r=>r.accession);if(n.length===0)return new Map;const c=t.map(r=>r.field),l=Object.fromEntries(Object.entries(x.lapisUrls).filter(([r])=>!r.includes("organism"))),m=Object.entries(l).map(async([r,s])=>{try{return((await D.post(`${s}/sample/details`,{accessionVersion:n,fields:["accessionVersion",...c],dataFormat:"json"})).data?.data??[]).map(f=>({...f,organism:r}))}catch{return[]}}),p=(await Promise.all(m)).flat(),a=new Map;return p.forEach(r=>{const s=r,o={accession:String(s.accessionVersion),organism:String(s.organism)};c.forEach(d=>{o[d]=s[d]}),a.set(String(s.accessionVersion),o)}),a},F=({seqSetRecords:i,clientConfig:x,fieldsToDisplay:t=[{field:"geoLocCountry",displayName:"Country"},{field:"sampleCollectionDate",displayName:"Collection Date"},{field:"authors",displayName:"Authors"}],sortByKey:n="isFocal",organismDisplayNames:c={}})=>{const{data:l,isLoading:m}=S({queryKey:["seqset-records-metadata",i,x,t],queryFn:()=>E(i,x,t),staleTime:3e5});if(i.length===0)return null;const h={[A.loculus]:a=>`/seq/${a}`},p=w.useMemo(()=>[...i].sort((a,r)=>{const s=a[n],o=r[n];return s>o?-1:s<o?1:0}),[i,n]);return e.jsxs("table",{className:"table-fixed w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left font-medium w-1/6",children:"Accession"}),e.jsx("th",{className:"text-left font-medium w-1/4",children:"Organism"}),e.jsx("th",{className:"text-left font-medium w-1/6",children:"Context"}),t.map(a=>e.jsx("th",{className:"text-left font-medium",children:a.displayName},a.field))]})}),e.jsx("tbody",{children:p.map((a,r)=>{const s=l?.get(a.accession),o=()=>{window.location.href=h[a.type](a.accession)};return e.jsxs("tr",{className:"hover:bg-primary-100 border-gray-100 cursor-pointer",onClick:o,children:[e.jsx("td",{className:"text-left pr-4 truncate max-w-0",title:a.accession,children:a.accession}),e.jsx("td",{className:"text-left pr-4 truncate max-w-0",title:s?.organism?c[s.organism]??s.organism:"N/A",children:m?e.jsx("span",{className:"loading loading-spinner loading-xs"}):s?.organism?c[s.organism]??s.organism:"N/A"}),e.jsx("td",{className:"text-left pr-4 truncate max-w-0",children:a.isFocal?"Focal":"Background"}),t.map(d=>e.jsx("td",{className:"text-left pr-4 truncate max-w-0",title:String(s?.[d.field]??""),children:m?e.jsx("span",{className:"loading loading-spinner loading-xs"}):String(s?.[d.field]??"")},d.field))]},`accessionData-${r}`)})})]})},y=P("SeqSetItem"),V=({clientConfig:i,accessToken:x,seqSet:t,seqSetRecords:n,citedByData:c,isAdminView:l=!1,fieldsToDisplay:m,organismDisplayNames:h})=>{const[p,a]=w.useState(1),r=10,{mutate:s}=_(i,x,t.seqSetId,t.seqSetVersion,u=>I.error(u,{position:"top-center",autoClose:!1})),o=()=>{s(void 0)},d=()=>`https://search.crossref.org/search/works?from_ui=yes&q=${t.seqSetDOI}`,g=u=>u===void 0?"N/A":new Date(u).toISOString().split("T")[0],f=()=>t.seqSetDOI!==void 0&&t.seqSetDOI!==null?`https://doi.org/${t.seqSetDOI}`:l?e.jsx("a",{className:"mr-4 cursor-pointer font-medium text-blue-600 hover:text-blue-800",onClick:()=>q({dialogText:"Are you sure you want to create a DOI for this version of your seqSet?",onConfirmation:o}),children:"Generate a DOI"}):"N/A",j=()=>Math.ceil(n.length/r),b=()=>n.slice((p-1)*r,p*r);return e.jsxs("div",{className:"flex flex-col items-left",children:[e.jsx("div",{children:e.jsx("h1",{className:"text-2xl font-semibold pb-4",children:t.name})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex flex-row py-1.5",children:[e.jsx("p",{className:"mr-8 w-[120px] text-gray-500 text-right",children:"Description"}),e.jsx("p",{className:"text max-w-lg",children:t.description??"N/A"})]}),e.jsxs("div",{className:"flex flex-row py-1.5",children:[e.jsx("p",{className:"mr-8 w-[120px] text-gray-500 text-right",children:"Version"}),e.jsx("p",{className:"text max-w-lg",children:t.seqSetVersion})]}),e.jsxs("div",{className:"flex flex-row py-1.5",children:[e.jsx("p",{className:"mr-8 w-[120px] text-gray-500 text-right",children:"Created date"}),e.jsx("p",{className:"text max-w-lg",children:g(t.createdAt)})]}),e.jsxs("div",{className:"flex flex-row py-1.5",children:[e.jsx("p",{className:"mr-8 w-[120px] text-gray-500 text-right",children:"Size"}),e.jsx("p",{className:"text max-w-lg",children:`${n.length} sequence${n.length===1?"":"s"}`})]}),e.jsxs("div",{className:"flex flex-row py-1.5",children:[e.jsx("p",{className:"mr-8 w-[120px] text-gray-500 text-right",children:"DOI"}),f()]}),e.jsxs("div",{className:"flex flex-row py-1.5",children:[e.jsx("p",{className:"mr-8 w-[120px] text-gray-500 text-right",children:"Total citations"}),t.seqSetDOI===void 0||t.seqSetDOI===null?e.jsx("p",{className:"text",children:"Cited by 0"}):e.jsx("a",{className:"mr-4 cursor-pointer font-medium text-blue-600 hover:text-blue-800",href:d(),target:"_blank",children:"Cited by 0"})]}),e.jsxs("div",{className:"flex flex-row",children:[e.jsx("p",{className:"mr-0 w-[120px]"}),e.jsxs("div",{className:"ml-4",children:[e.jsx(C,{citedByData:c}),e.jsx("p",{className:"text-sm text-center text-gray-500 my-4 ml-8 max-w-64",children:"Number of times this SeqSet has been cited by a publication"})]})]})]}),e.jsxs("div",{className:"flex flex-col my-4",children:[e.jsx("p",{className:"text-xl my-4 font-semibold",children:"Sequences"}),e.jsx(F,{seqSetRecords:b(),clientConfig:i,fieldsToDisplay:m,organismDisplayNames:h}),j()>1?e.jsx(k,{className:"my-4 w-full flex justify-center",page:p,count:j(),color:"primary",variant:"outlined",shape:"rounded",onChange:(u,N)=>{a(N)}}):null]})]})};function _(i,x,t,n,c){return $(i).useCreateSeqSetDOI({headers:O(x),params:{seqSetId:t,seqSetVersion:n}},{onSuccess:async()=>{await y.info(`Successfully created seqSet DOI for seqSetId: ${t}, version ${n}`),location.reload()},onError:async l=>{if(await y.info(`Failed to create seqSet DOI with error: '${JSON.stringify(l)})}'`),l instanceof v){const m=l.response?.data;l.response?.data!==void 0&&c(`Failed to update seqSet. ${m?.title}. ${m?.detail}`)}}})}const se=M(V);export{se as SeqSetItem};
