import{j as n}from"./jsx-runtime.C9E4cUVc.js";import{c as ee,a as Dt,e as Pt}from"./createAuthorizationHeader.D0lXW5f5.js";import{y as Mt,T as kt,w as Ct,j as $t,U as Rt,V as Tt,W as At,X as ot,Y as Pe,O as lt}from"./lapis.BMBLPoxt.js";import{r as h,R as A}from"./index.BOC3FD3Q.js";import{r as Ke}from"./routes.B4evqrXf.js";import{P as Me,e as ke,o as ct,I as qt,F as He,d as Ut,f as Lt,R as Qe,E as zt,a as Bt,M as Wt,c as Kt}from"./SequencesForm.CPpvmeJc.js";import{y as dt}from"./_astro-entry_react-toastify.w1t6keWD.js";import{M as Ht}from"./react-tooltip.min.CEnrnmjl.js";import{B as Qt}from"./BaseDialog.CUAmSNVi.js";import{K as ce,y as de,o as D,f as C,r as Gt,$ as Vt,a as Xt,w as Yt,_ as ut,e as Jt,L as ue,u as Zt,x as es,i as xe,p as mt,g as ts,d as te,R as ss,h as as,n as Ce,b as ns,c as rs,O as Ge}from"./open-closed.CJcKiZsm.js";import{r as Q}from"./index.CExoqQxK.js";import{p as is,l as os,a as ls,T as cs,u as ds,j as us}from"./baseline-download.BIAEx4Am.js";import{s as ms,a as ps}from"./unlocked.BhwIO2z4.js";import{Q as fs,B as hs,d as xs,F as ys,l as P,I as bs,U as vs,x as gs,n as js,m as ws,g as Ss,h as _s,R as Ns,e as Os,p as Es,q as Ve,j as Is,r as Fs,u as Ds,D as Ps,k as Ms,A as ks,v as Cs,K as $s,M as Rs,t as Ee,_ as Ts}from"./index.B7uol7Hd.js";import{g as As}from"./clientLogger.CHIvnBnE.js";import{u as qs}from"./isClient.CwQyaCl4.js";import{D as Us}from"./DataUseTermsSelector.gm_aX7OF.js";import{S as Ls}from"./SubmissionRoute.C0UznQB_.js";import{b as zs,a as Bs}from"./serviceHooks.qDjWrls6.js";import{s as Xe}from"./stringifyMaybeAxiosError.Dyiug7p6.js";import{d as Ws}from"./ConfirmationDialog.DES7BW3S.js";import{D as Ks}from"./DisabledUntilHydrated.BWqRU456.js";import{w as Hs}from"./withQueryProvider.C5jGp74p.js";var Qs=(e=>(e[e.Open=0]="Open",e[e.Closed=1]="Closed",e))(Qs||{}),Gs=(e=>(e[e.Single=0]="Single",e[e.Multi=1]="Multi",e))(Gs||{}),Vs=(e=>(e[e.Pointer=0]="Pointer",e[e.Other=1]="Other",e))(Vs||{}),Xs=(e=>(e[e.OpenListbox=0]="OpenListbox",e[e.CloseListbox=1]="CloseListbox",e[e.GoToOption=2]="GoToOption",e[e.Search=3]="Search",e[e.ClearSearch=4]="ClearSearch",e[e.RegisterOption=5]="RegisterOption",e[e.UnregisterOption=6]="UnregisterOption",e[e.SetButtonElement=7]="SetButtonElement",e[e.SetOptionsElement=8]="SetOptionsElement",e))(Xs||{});function Ie(e,t=s=>s){let s=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,a=Ts(t(e.options.slice()),i=>i.dataRef.current.domRef.current),r=s?a.indexOf(s):null;return r===-1&&(r=null),{options:a,activeOptionIndex:r}}let Ys={1(e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1,__demoMode:!1}},0(e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let t=e.activeOptionIndex,{isSelected:s}=e.dataRef.current,a=e.options.findIndex(r=>s(r.dataRef.current.value));return a!==-1&&(t=a),{...e,listboxState:0,activeOptionIndex:t,__demoMode:!1}},2(e,t){var s,a,r,i,o;if(e.dataRef.current.disabled||e.listboxState===1)return e;let l={...e,searchQuery:"",activationTrigger:(s=t.trigger)!=null?s:1,__demoMode:!1};if(t.focus===P.Nothing)return{...l,activeOptionIndex:null};if(t.focus===P.Specific)return{...l,activeOptionIndex:e.options.findIndex(d=>d.id===t.id)};if(t.focus===P.Previous){let d=e.activeOptionIndex;if(d!==null){let m=e.options[d].dataRef.current.domRef,w=Ee(t,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:j=>j.id,resolveDisabled:j=>j.dataRef.current.disabled});if(w!==null){let j=e.options[w].dataRef.current.domRef;if(((a=m.current)==null?void 0:a.previousElementSibling)===j.current||((r=j.current)==null?void 0:r.previousElementSibling)===null)return{...l,activeOptionIndex:w}}}}else if(t.focus===P.Next){let d=e.activeOptionIndex;if(d!==null){let m=e.options[d].dataRef.current.domRef,w=Ee(t,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:j=>j.id,resolveDisabled:j=>j.dataRef.current.disabled});if(w!==null){let j=e.options[w].dataRef.current.domRef;if(((i=m.current)==null?void 0:i.nextElementSibling)===j.current||((o=j.current)==null?void 0:o.nextElementSibling)===null)return{...l,activeOptionIndex:w}}}}let c=Ie(e),f=Ee(t,{resolveItems:()=>c.options,resolveActiveIndex:()=>c.activeOptionIndex,resolveId:d=>d.id,resolveDisabled:d=>d.dataRef.current.disabled});return{...l,...c,activeOptionIndex:f}},3:(e,t)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let s=e.searchQuery!==""?0:1,a=e.searchQuery+t.value.toLowerCase(),r=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+s).concat(e.options.slice(0,e.activeOptionIndex+s)):e.options).find(o=>{var l;return!o.dataRef.current.disabled&&((l=o.dataRef.current.textValue)==null?void 0:l.startsWith(a))}),i=r?e.options.indexOf(r):-1;return i===-1||i===e.activeOptionIndex?{...e,searchQuery:a}:{...e,searchQuery:a,activeOptionIndex:i,activationTrigger:1}},4(e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},5:(e,t)=>{let s={id:t.id,dataRef:t.dataRef},a=Ie(e,r=>[...r,s]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(t.dataRef.current.value)&&(a.activeOptionIndex=a.options.indexOf(s)),{...e,...a}},6:(e,t)=>{let s=Ie(e,a=>{let r=a.findIndex(i=>i.id===t.id);return r!==-1&&a.splice(r,1),a});return{...e,...s,activationTrigger:1}},7:(e,t)=>e.buttonElement===t.element?e:{...e,buttonElement:t.element},8:(e,t)=>e.optionsElement===t.element?e:{...e,optionsElement:t.element}},ze=h.createContext(null);ze.displayName="ListboxActionsContext";function ge(e){let t=h.useContext(ze);if(t===null){let s=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,ge),s}return t}let je=h.createContext(null);je.displayName="ListboxDataContext";function me(e){let t=h.useContext(je);if(t===null){let s=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,me),s}return t}function Js(e,t){return te(t.type,Ys,e,t)}let Zs=h.Fragment;function ea(e,t){var s;let a=Ps(),{value:r,defaultValue:i,form:o,name:l,onChange:c,by:f,invalid:d=!1,disabled:m=a||!1,horizontal:w=!1,multiple:j=!1,__demoMode:p=!1,...u}=e;const y=w?"horizontal":"vertical";let x=de(t),g=ls(i),[v=j?[]:void 0,_]=cs(r,c,g),[O,b]=h.useReducer(Js,{dataRef:h.createRef(),listboxState:p?0:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1,buttonElement:null,optionsElement:null,__demoMode:p}),M=h.useRef({static:!1,hold:!1}),E=h.useRef(new Map),I=ds(f),$=h.useCallback(F=>te(S.mode,{1:()=>v.some(k=>I(k,F)),0:()=>I(v,F)}),[v]),S=h.useMemo(()=>({...O,value:v,disabled:m,invalid:d,mode:j?1:0,orientation:y,compare:I,isSelected:$,optionsPropsRef:M,listRef:E}),[v,m,d,j,O,E]);Ce(()=>{O.dataRef.current=S},[S]);let L=S.listboxState===0;Ms(L,[S.buttonElement,S.optionsElement],(F,k)=>{var U;b({type:1}),ks(k,Cs.Loose)||(F.preventDefault(),(U=S.buttonElement)==null||U.focus())});let z=h.useMemo(()=>({open:S.listboxState===0,disabled:m,invalid:d,value:v}),[S,m,v,d]),B=D(F=>{let k=S.options.find(U=>U.id===F);k&&re(k.dataRef.current.value)}),X=D(()=>{if(S.activeOptionIndex!==null){let{dataRef:F,id:k}=S.options[S.activeOptionIndex];re(F.current.value),b({type:2,focus:P.Specific,id:k})}}),Y=D(()=>b({type:0})),W=D(()=>b({type:1})),K=mt(),J=D((F,k,U)=>{K.dispose(),K.microTask(()=>F===P.Specific?b({type:2,focus:P.Specific,id:k,trigger:U}):b({type:2,focus:F,trigger:U}))}),ne=D((F,k)=>(b({type:5,id:F,dataRef:k}),()=>b({type:6,id:F}))),re=D(F=>te(S.mode,{0(){return _?.(F)},1(){let k=S.value.slice(),U=k.findIndex(Ft=>I(Ft,F));return U===-1?k.push(F):k.splice(U,1),_?.(k)}})),Ne=D(F=>b({type:3,value:F})),N=D(()=>b({type:4})),R=D(F=>{b({type:7,element:F})}),Z=D(F=>{b({type:8,element:F})}),Oe=h.useMemo(()=>({onChange:re,registerOption:ne,goToOption:J,closeListbox:W,openListbox:Y,selectActiveOption:X,selectOption:B,search:Ne,clearSearch:N,setButtonElement:R,setOptionsElement:Z}),[]),[_t,Nt]=$s({inherit:!0}),Ot={ref:x},Et=h.useCallback(()=>{if(g!==void 0)return _?.(g)},[_,g]),It=ue();return A.createElement(Nt,{value:_t,props:{htmlFor:(s=S.buttonElement)==null?void 0:s.id},slot:{open:S.listboxState===0,disabled:m}},A.createElement(Rs,null,A.createElement(ze.Provider,{value:Oe},A.createElement(je.Provider,{value:S},A.createElement(rs,{value:te(S.listboxState,{0:xe.Open,1:xe.Closed})},l!=null&&v!=null&&A.createElement(us,{disabled:m,data:{[l]:v},form:o,onReset:Et}),It({ourProps:Ot,theirProps:u,slot:z,defaultTag:Zs,name:"Listbox"}))))))}let ta="button";function sa(e,t){var s;let a=me("Listbox.Button"),r=ge("Listbox.Button"),i=h.useId(),o=hs(),{id:l=o||`headlessui-listbox-button-${i}`,disabled:c=a.disabled||!1,autoFocus:f=!1,...d}=e,m=de(t,xs(),r.setButtonElement),w=ys(),j=D(S=>{switch(S.key){case C.Enter:is(S.currentTarget);break;case C.Space:case C.ArrowDown:S.preventDefault(),Q.flushSync(()=>r.openListbox()),a.value||r.goToOption(P.First);break;case C.ArrowUp:S.preventDefault(),Q.flushSync(()=>r.openListbox()),a.value||r.goToOption(P.Last);break}}),p=D(S=>{switch(S.key){case C.Space:S.preventDefault();break}}),u=D(S=>{var L;if(Gt(S.currentTarget))return S.preventDefault();a.listboxState===0?(Q.flushSync(()=>r.closeListbox()),(L=a.buttonElement)==null||L.focus({preventScroll:!0})):(S.preventDefault(),r.openListbox())}),y=D(S=>S.preventDefault()),x=bs([l]),g=vs(),{isFocusVisible:v,focusProps:_}=Vt({autoFocus:f}),{isHovered:O,hoverProps:b}=Xt({isDisabled:c}),{pressed:M,pressProps:E}=Yt({disabled:c}),I=h.useMemo(()=>({open:a.listboxState===0,active:M||a.listboxState===0,disabled:c,invalid:a.invalid,value:a.value,hover:O,focus:v,autofocus:f}),[a.listboxState,a.value,c,O,v,M,a.invalid,f]),$=ut(w(),{ref:m,id:l,type:Jt(e,a.buttonElement),"aria-haspopup":"listbox","aria-controls":(s=a.optionsElement)==null?void 0:s.id,"aria-expanded":a.listboxState===0,"aria-labelledby":x,"aria-describedby":g,disabled:c||void 0,autoFocus:f,onKeyDown:j,onKeyUp:p,onKeyPress:y,onClick:u},_,b,E);return ue()({ourProps:$,theirProps:d,slot:I,defaultTag:ta,name:"Listbox.Button"})}let pt=h.createContext(!1),aa="div",na=Ge.RenderStrategy|Ge.Static;function ra(e,t){var s,a;let r=h.useId(),{id:i=`headlessui-listbox-options-${r}`,anchor:o,portal:l=!1,modal:c=!0,transition:f=!1,...d}=e,m=gs(o),[w,j]=h.useState(null);m&&(l=!0);let p=me("Listbox.Options"),u=ge("Listbox.Options"),y=js(p.optionsElement),x=Zt(),[g,v]=es(f,w,x!==null?(x&xe.Open)===xe.Open:p.listboxState===0);ws(g,p.buttonElement,u.closeListbox);let _=p.__demoMode?!1:c&&p.listboxState===0;Ss(_,y);let O=p.__demoMode?!1:c&&p.listboxState===0;_s(O,{allowed:h.useCallback(()=>[p.buttonElement,p.optionsElement],[p.buttonElement,p.optionsElement])});let b=p.listboxState!==0,M=ms(b,p.buttonElement)?!1:g,E=g&&p.listboxState===1,I=os(E,p.value),$=D(N=>p.compare(I,N)),S=h.useMemo(()=>{var N;if(m==null||!((N=m?.to)!=null&&N.includes("selection")))return null;let R=p.options.findIndex(Z=>$(Z.dataRef.current.value));return R===-1&&(R=0),R},[m,p.options]),L=(()=>{if(m==null)return;if(S===null)return{...m,inner:void 0};let N=Array.from(p.listRef.current.values());return{...m,inner:{listRef:{current:N},index:S}}})(),[z,B]=Ns(L),X=Os(),Y=de(t,m?z:null,u.setOptionsElement,j),W=mt();h.useEffect(()=>{var N;let R=p.optionsElement;R&&p.listboxState===0&&R!==((N=ts(R))==null?void 0:N.activeElement)&&R?.focus({preventScroll:!0})},[p.listboxState,p.optionsElement]);let K=D(N=>{var R,Z;switch(W.dispose(),N.key){case C.Space:if(p.searchQuery!=="")return N.preventDefault(),N.stopPropagation(),u.search(N.key);case C.Enter:if(N.preventDefault(),N.stopPropagation(),p.activeOptionIndex!==null){let{dataRef:Oe}=p.options[p.activeOptionIndex];u.onChange(Oe.current.value)}p.mode===0&&(Q.flushSync(()=>u.closeListbox()),(R=p.buttonElement)==null||R.focus({preventScroll:!0}));break;case te(p.orientation,{vertical:C.ArrowDown,horizontal:C.ArrowRight}):return N.preventDefault(),N.stopPropagation(),u.goToOption(P.Next);case te(p.orientation,{vertical:C.ArrowUp,horizontal:C.ArrowLeft}):return N.preventDefault(),N.stopPropagation(),u.goToOption(P.Previous);case C.Home:case C.PageUp:return N.preventDefault(),N.stopPropagation(),u.goToOption(P.First);case C.End:case C.PageDown:return N.preventDefault(),N.stopPropagation(),u.goToOption(P.Last);case C.Escape:N.preventDefault(),N.stopPropagation(),Q.flushSync(()=>u.closeListbox()),(Z=p.buttonElement)==null||Z.focus({preventScroll:!0});return;case C.Tab:N.preventDefault(),N.stopPropagation(),Q.flushSync(()=>u.closeListbox()),Es(p.buttonElement,N.shiftKey?Ve.Previous:Ve.Next);break;default:N.key.length===1&&(u.search(N.key),W.setTimeout(()=>u.clearSearch(),350));break}}),J=(s=p.buttonElement)==null?void 0:s.id,ne=h.useMemo(()=>({open:p.listboxState===0}),[p.listboxState]),re=ut(m?X():{},{id:i,ref:Y,"aria-activedescendant":p.activeOptionIndex===null||(a=p.options[p.activeOptionIndex])==null?void 0:a.id,"aria-multiselectable":p.mode===1?!0:void 0,"aria-labelledby":J,"aria-orientation":p.orientation,onKeyDown:K,role:"listbox",tabIndex:p.listboxState===0?0:void 0,style:{...d.style,...B,"--button-width":Is(p.buttonElement,!0).width},...ss(v)}),Ne=ue();return A.createElement(Fs,{enabled:l?e.static||g:!1},A.createElement(je.Provider,{value:p.mode===1?p:{...p,isSelected:$}},Ne({ourProps:re,theirProps:d,slot:ne,defaultTag:aa,features:na,visible:M,name:"Listbox.Options"})))}let ia="div";function oa(e,t){let s=h.useId(),{id:a=`headlessui-listbox-option-${s}`,disabled:r=!1,value:i,...o}=e,l=h.useContext(pt)===!0,c=me("Listbox.Option"),f=ge("Listbox.Option"),d=c.activeOptionIndex!==null?c.options[c.activeOptionIndex].id===a:!1,m=c.isSelected(i),w=h.useRef(null),j=ps(w),p=as({disabled:r,value:i,domRef:w,get textValue(){return j()}}),u=de(t,w,I=>{I?c.listRef.current.set(a,I):c.listRef.current.delete(a)});Ce(()=>{if(!c.__demoMode&&c.listboxState===0&&d&&c.activationTrigger!==0)return ns().requestAnimationFrame(()=>{var I,$;($=(I=w.current)==null?void 0:I.scrollIntoView)==null||$.call(I,{block:"nearest"})})},[w,d,c.__demoMode,c.listboxState,c.activationTrigger,c.activeOptionIndex]),Ce(()=>{if(!l)return f.registerOption(a,p)},[p,a,l]);let y=D(I=>{var $;if(r)return I.preventDefault();f.onChange(i),c.mode===0&&(Q.flushSync(()=>f.closeListbox()),($=c.buttonElement)==null||$.focus({preventScroll:!0}))}),x=D(()=>{if(r)return f.goToOption(P.Nothing);f.goToOption(P.Specific,a)}),g=Ds(),v=D(I=>{g.update(I),!r&&(d||f.goToOption(P.Specific,a,0))}),_=D(I=>{g.wasMoved(I)&&(r||d||f.goToOption(P.Specific,a,0))}),O=D(I=>{g.wasMoved(I)&&(r||d&&f.goToOption(P.Nothing))}),b=h.useMemo(()=>({active:d,focus:d,selected:m,disabled:r,selectedOption:m&&l}),[d,m,r,l]),M=l?{}:{id:a,ref:u,role:"option",tabIndex:r===!0?void 0:-1,"aria-disabled":r===!0?!0:void 0,"aria-selected":m,disabled:void 0,onClick:y,onFocus:x,onPointerEnter:v,onMouseEnter:v,onPointerMove:_,onMouseMove:_,onPointerLeave:O,onMouseLeave:O},E=ue();return!m&&l?null:E({ourProps:M,theirProps:o,slot:b,defaultTag:ia,name:"Listbox.Option"})}let la=h.Fragment;function ca(e,t){let{options:s,placeholder:a,...r}=e,i={ref:de(t)},o=me("ListboxSelectedOption"),l=h.useMemo(()=>({}),[]),c=o.value===void 0||o.value===null||o.mode===1&&Array.isArray(o.value)&&o.value.length===0,f=ue();return A.createElement(pt.Provider,{value:!0},f({ourProps:i,theirProps:{...r,children:A.createElement(A.Fragment,null,a&&c?a:s)},slot:l,defaultTag:la,name:"ListboxSelectedOption"}))}let da=ce(ea),ft=ce(sa),ua=fs,ht=ce(ra),$e=ce(oa),ma=ce(ca),pa=Object.assign(da,{Button:ft,Label:ua,Options:ht,Option:$e,SelectedOption:ma});const fa="/docs/concepts/metadataformat/?organism={organism}",Ye=(e,t,s=2,a=!1)=>{if(a||(e=e.toLowerCase(),t=t.toLowerCase()),e.length<s||t.length<s)return 0;const r=new Map;for(let o=0;o<e.length-(s-1);o++){const l=e.substring(o,o+s);r.set(l,(r.get(l)??0)+1)}let i=0;for(let o=0;o<t.length-(s-1);o++){const l=t.substring(o,o+s),c=r.get(l)??0;c>0&&(r.set(l,c-1),i++)}return i*2/(e.length+t.length-(s-1)*2)};class ie{constructor(t){this.map=t}static getBestMatchingTargetColumn(t,s){if(s.length===0)return null;const[a,r]=s.map(i=>{const o=Math.max(Ye(t,i.name),Ye(t,i.displayName??""));return[i.name,o]}).reduce((i,o)=>o[1]>i[1]?o:i);return r>.8?a:null}static fromColumns(t,s){const a=new Map;let r=s,i=t;return t.forEach(o=>a.set(o,null)),t.forEach(o=>{const l=r.find(c=>c.name===o||c.displayName===o);l&&(a.set(o,l.name),r=r.filter(c=>c.name!==o),i=i.filter(c=>c!==o))}),i.includes("submissionId")&&r.find(o=>o.name==="id")&&(a.set("submissionId","id"),r=r.filter(o=>o.name!=="id"),i=i.filter(o=>o!=="submissionId")),i.forEach(o=>{const l=this.getBestMatchingTargetColumn(o,r);a.set(o,l),r=r.filter(c=>c.name!==l)}),new ie(a)}update(t,s){const a=new Map(t.map(r=>{const i=this.map.get(r);return i&&s.map(o=>o.name).includes(i)?[r,i]:[r,null]}));return new ie(a)}entries(){return Array.from(this.map.entries())}usedColumns(){return Array.from(this.map.values()).filter(t=>t!==null)}updateWith(t,s){const a=new Map(this.map);return a.set(t,s),this.map.forEach((r,i)=>r===s&&a.set(i,null)),new ie(a)}async applyTo(t){const s=await t.text(),r=Me.parse(s,{delimiter:"	",skipEmptyLines:!0}).data,i=r.splice(0,1)[0],o=[],l=[];this.entries().forEach(([d,m])=>{m!==null&&(o.push(m),l.push(i.findIndex(w=>w===d)))});const c=r.map(d=>l.map(m=>d[m])),f=Me.unparse([o,...c],{delimiter:"	",newline:`
`});return new File([f],"remapped.tsv")}equals(t){return t===null?!1:((a,r)=>a.size===r.size&&Array.from(a.keys()).every(i=>a.get(i)===r.get(i)))(this.map,t.map)}}const ha=({inputFile:e,columnMapping:t,setColumnMapping:s,groupedInputFields:a})=>{const[r,i]=h.useState(!1),o=()=>i(!0),l=()=>i(!1),[c,f]=h.useState(null),[d,m]=h.useState(null);h.useEffect(()=>{if(!r)return;(async()=>{(await xa(e)).match(E=>m(E),E=>{dt.error(`Could not read file header: ${E.message}`),i(!1)})})()},[r,e,m]),h.useEffect(()=>{if(d===null)return;const b=Array.from(a.values()).flat();f(t!==null?t.update(d,b):ie.fromColumns(d,b))},[d,t,a,f]);const w=()=>{s(c),l()},j=()=>{s(null),l()},p=Array.from(a.values()).flat().filter(b=>b.required),y=p.filter((b,M)=>p.findIndex(E=>E.name===b.name)===M).filter(b=>!c?.usedColumns().includes(b.name)),g=!t?.equals(c)&&y.length===0,v=t!==null?"Edit column mapping":"Add column mapping",_=t===null?"Add this mapping":"Save",O=xt(a);return n.jsxs(n.Fragment,{children:[n.jsx("button",{className:"text-xs break-words text-gray-700 py-1.5 px-4 border border-gray-300 rounded-md hover:bg-gray-50","data-tooltip-id":"columnMapping",onClick:b=>{b.preventDefault(),o()},children:v}),n.jsxs(Ht,{id:"columnMapping",place:"bottom",globalCloseEvents:{scroll:!0,clickOutsideAnchor:!0},openEvents:{mouseenter:!0,focus:!1},closeEvents:{mouseleave:!0,blur:!0},children:["If your metadata file does not use the defined field names, this allow you",n.jsx("br",{}),"to map columns in your file to the fields expected by the database."]}),n.jsx(Qt,{title:"Remap columns",isOpen:r,onClose:l,fullWidth:!1,children:c===null||d===null?"Loading ...":n.jsxs("div",{className:"space-y-4",children:[n.jsxs("table",{children:[n.jsx("thead",{children:n.jsxs("tr",{children:[n.jsx("th",{className:"py-2 sm:min-w-56",children:"Column in your file"}),n.jsx("th",{style:O,children:"Submission column"})]})}),n.jsx("tbody",{children:c.entries().map(([b,M])=>n.jsx(ya,{selectingFor:b,selectedOption:M,options:a,usedOptions:c.usedColumns(),setColumnMapping:f},b))})]}),n.jsx("div",{className:"min-h-6 text-sm",children:y.length>0&&"All required fields need to be set to apply this mapping."}),n.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[t!==null&&n.jsxs(n.Fragment,{children:[n.jsx("button",{className:"btn bg-white text-red-800 border-red-800",onClick:j,children:"Discard Mapping"}),n.jsx("div",{className:"flex-1"})]}),n.jsx("button",{className:"btn",onClick:l,children:"Cancel"}),n.jsx("button",{className:"btn loculusColor text-white",onClick:w,disabled:!g,children:_})]})]})})]})};async function xa(e){let t;try{t=await e.text()}catch(a){return Promise.resolve(ke(a))}const s=Me.parse(t,{delimiter:"	",skipEmptyLines:!0});return ct(s.data[0])}const ya=({selectingFor:e,options:t,usedOptions:s,selectedOption:a,setColumnMapping:r})=>{const i=a?Array.from(t.values()).flat().find(d=>d.name===a):void 0,o=i?.displayName??i?.name,l=i?.displayName===e||i?.name===e,c=xt(t),f=(d,m)=>n.jsxs($e,{value:m.name,className:`data-[focus]:bg-primary-200 p-1 pl-3 rounded-sm ${a===m.name?"bg-gray-200":""}`,"data-tooltip-id":`${d}-${m.name}-tooltip`,children:[n.jsx("span",{className:s.includes(m.name)?"text-gray-400":"",children:m.displayName??m.name}),n.jsx(qt,{id:`${d}-${m.name}-tooltip`,field:m})]},`${d}-${m.name}`);return n.jsxs("tr",{className:"border-gray-400 border-solid border-x-0 border-y",children:[n.jsx("td",{className:"pr-4",children:e}),n.jsx("td",{style:c,children:n.jsxs(pa,{value:a,onChange:d=>r(m=>m.updateWith(e,d)),children:[n.jsx(ft,{className:"rounded-md border-none px-0 py-1 w-full pr-2",children:n.jsxs("div",{className:"flex flex-row w-full mr-0",children:[a?n.jsx("span",{className:l?"":"italic",children:o}):n.jsx("span",{className:"italic text-gray-400",children:"unmapped"}),n.jsx("div",{className:"flex-1"}),n.jsx("span",{className:"ml-2 mb-1 rotate-180 text-gray-500",children:n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:n.jsx("path",{fillRule:"evenodd",d:"M10 3l7 10H3l7-10z"})})})]})}),n.jsxs(ht,{anchor:"top",className:"bg-gray-100 p-1 rounded-sm text-sm",children:[n.jsx($e,{value:null,className:"data-[focus]:bg-primary-200 p-1",children:n.jsx("span",{className:"italic",children:"unmapped"})},""),n.jsx("div",{className:"w-10/12 mx-auto my-1 h-0.5 bg-gray-200"},"border"),Array.from(t.entries()).map(([d,m])=>{if(m.length!==0)return n.jsxs("div",{className:"pt-1",children:[n.jsx("div",{className:"p-1 font-semibold",children:d}),m.map(w=>f(d,w))]},d)})]})]})})]},e)};function xt(e){const t=Math.max(...Array.from(e.values()).flat().flatMap(s=>[s.name,s.displayName]).map(s=>s?.length??0));return{minWidth:`${Math.ceil(t/2)+2}rem`}}const ba="/docs/how-to/upload-sequences",va=({organism:e,action:t,metadataFile:s,setMetadataFile:a,sequenceFile:r,setSequenceFile:i,columnMapping:o,setColumnMapping:l,referenceGenomeSequenceNames:c,metadataTemplateFields:f,enableConsensusSequences:d,isMultiSegmented:m})=>{const[w,j]=h.useState(10),p=()=>{const{metadataFileContent:y,revisedMetadataFileContent:x,sequenceFileContent:g}=ja(w),_=Je(t==="submit"?y:x,"text/tab-separated-values","metadata.tsv");if(a(new Qe(_)),d){const O=Je(g,"application/octet-stream","sequences.fasta");i(new Qe(O))}},u=fa.replace("{organism}",e);return n.jsxs("div",{className:"grid sm:grid-cols-3 gap-x-16",children:[n.jsxs("div",{className:"",children:[n.jsx("h2",{className:"font-medium text-lg",children:d?"Sequences and metadata":"Metadata"}),n.jsxs("p",{className:"text-gray-500 text-sm",children:["Select your ",d&&"sequence data and ","metadata files"]}),n.jsxs("p",{className:"text-gray-400 text-xs mt-5",children:[t==="revise"&&n.jsx("span",{children:n.jsxs("strong",{children:['For revisions, your metadata file must contain an "accession" column, containing for each row the accession already in the database. ',n.jsx("br",{})]})}),"The documentation pages contain more details on the required"," ",n.jsx("a",{href:u,className:"text-primary-700 opacity-90",children:"metadata format"})," ","including a list of all supported metadata. You can download a"," ",n.jsx("a",{href:Ke.metadataTemplate(e,t,"tsv"),className:"text-primary-700 opacity-90",children:"TSV"})," or ",n.jsx("a",{href:Ke.metadataTemplate(e,t,"xlsx"),className:"text-primary-700 opacity-90",children:"XLSX"})," ","template with column headings for the metadata file."]}),m&&n.jsxs("p",{className:"text-gray-400 text-xs mt-3",children:[e.toUpperCase()," has a multi-segmented genome. Please submit one metadata entry with a unique ",n.jsx("i",{children:"submissionId"})," for the full multi-segmented sample, e.g. ",n.jsx("b",{children:"sample1"}),". Sequence data should be a FASTA file with each header indicating the ",n.jsx("i",{children:"submissionId"})," and the segment, i.e."," ",c.nucleotideSequences.map((y,x)=>n.jsxs("span",{className:"font-bold",children:["sample1_",y,x!==c.nucleotideSequences.length-1?", ":""]},x)),"."]}),n.jsxs("p",{className:"text-gray-400 text-xs mt-3",children:["Files can optionally be compressed using ",n.jsx("i",{children:".zst"}),", ",n.jsx("i",{children:".zip"})," or ",n.jsx("i",{children:".gz"}),"; for FASTA files"," ",n.jsx("i",{children:".xz"})," is also supported. For more information please refer to the"," ",n.jsx("a",{href:ba,className:"text-primary-700 opacity-90",children:"help pages"}),"."]}),(e.startsWith("not-aligned-organism")||e.startsWith("dummy-organism"))&&t==="submit"&&n.jsx(ga,{setExampleEntries:j,exampleEntries:w,handleLoadExampleData:p,dataIsLoaded:!!s&&(!d||!!r)})]}),n.jsx("form",{className:"sm:col-span-2 space-y-4",children:n.jsxs("div",{className:"flex flex-col lg:flex-row gap-6",children:[d&&n.jsxs("div",{className:"w-60 space-y-2",children:[n.jsx("label",{className:"text-gray-900 font-medium text-sm block",children:"Sequence file"}),n.jsx(He,{setFile:i,name:"sequence_file",ariaLabel:"Sequence File",fileKind:Ut})]}),n.jsxs("div",{className:"w-60 space-y-2",children:[n.jsx("label",{className:"text-gray-900 font-medium text-sm block",children:"Metadata file"}),n.jsxs("div",{className:"flex flex-col items-center w-full",children:[n.jsx(He,{setFile:a,name:"metadata_file",ariaLabel:"Metadata File",fileKind:Lt}),s!==void 0&&n.jsx(ha,{inputFile:s,columnMapping:o,setColumnMapping:l,groupedInputFields:f})]})]})]})})]})},ga=({setExampleEntries:e,exampleEntries:t,handleLoadExampleData:s,dataIsLoaded:a})=>n.jsxs("p",{className:"text-gray-800 text-xs mt-5 opacity-50",children:["Add dev example data",n.jsx("br",{}),n.jsx("input",{type:"number",value:t??"",onChange:r=>e(parseInt(r.target.value,10)),className:"w-32 h-6 rounded"}),n.jsx("button",{type:"button",onClick:s,className:"border rounded px-2 py-1 ml-2 h-6",children:"Load Example Data"})," ",n.jsx("br",{}),a&&n.jsx("span",{className:"text-xs text-gray-500",children:"Data loaded"})]});function ja(e=20){const t=["Europe","Asia","North America","South America","Africa","Australia"],s=["Switzerland","USA","China","Brazil","Nigeria","Australia"],a=["Bern","California","Beijing","Rio de Janeiro","Lagos","Sydney"],r=["Homo sapiens","Canis lupus familiaris"],i=["A","A.1","A.1.1","A.2","B"];let o=`submissionId	date	region	country	division	host	lineage
`,l=`accession	submissionId	date	region	country	division	host	lineage
`,c="";for(let f=0;f<e;f++){const d=`custom${f}`,m=new Date(Date.now()-Math.floor(Math.random()*365*24*60*60*1e3)).toISOString().split("T")[0],w=t[Math.floor(Math.random()*t.length)],j=s[Math.floor(Math.random()*s.length)],p=a[Math.floor(Math.random()*a.length)],u=r[Math.floor(Math.random()*r.length)],y=i[Math.floor(Math.random()*i.length)];o+=`${d}	${m}	${w}	${j}	${p}	${u}	${y}
`,l+=`${f+1}	${d}	${m}	${w}	${j}	${p}	${u}	${y}
`,c+=`>${d}
ACTG
`}return{metadataFileContent:o,revisedMetadataFileContent:l,sequenceFileContent:c}}function Je(e,t,s){const a=new Blob([e],{type:t});return new File([a],s,{type:t})}const Ze=({inputMode:e,setFileFactory:t,organism:s,action:a,referenceGenomeSequenceNames:r,metadataTemplateFields:i,submissionDataTypes:o})=>{const l=o.consensusSequences,c=r.nucleotideSequences.length>1,[f,d]=h.useState(zt.empty()),[m,w]=h.useState(Bt.fromSequenceNames(r.nucleotideSequences)),[j,p]=h.useState(void 0),[u,y]=h.useState(void 0),[x,g]=h.useState(null);return h.useEffect(()=>{t(()=>async()=>{switch(e){case"form":{const v=f.getSubmissionId();if(!v)return{type:"error",errorMessage:"Please specify an ID."};const _=f.getMetadataTsv();if(!_)return{type:"error",errorMessage:"Please specify metadata."};const O=m.getSequenceFasta(v);return!O&&l?{type:"error",errorMessage:"Please enter sequence data."}:{type:"ok",metadataFile:_,sequenceFile:O,submissionId:v}}case"bulk":{let v=j?.inner();if(j!==void 0&&x!==null&&(v=await x.applyTo(j)),v===void 0)return{type:"error",errorMessage:"Please specify a metadata file."};const _=u?.inner();return l&&_===void 0?{type:"error",errorMessage:"Please specify a sequences file."}:{type:"ok",metadataFile:v,sequenceFile:_}}}})},[f,m,j,u,l,x]),e==="bulk"?n.jsx(va,{organism:s,action:a,metadataFile:j,setMetadataFile:p,sequenceFile:u,setSequenceFile:y,columnMapping:x,setColumnMapping:g,referenceGenomeSequenceNames:r,metadataTemplateFields:i,enableConsensusSequences:l,isMultiSegmented:c}):n.jsxs(n.Fragment,{children:[n.jsx("table",{className:"customTable",children:n.jsx("tbody",{className:"w-full",children:n.jsx(Wt,{editableMetadata:f,setEditableMetadata:d,groupedInputFields:i,isSubmitForm:a==="submit"})})}),l&&n.jsx(Kt,{editableSequences:m,setEditableSequences:w})]})};var yt=Symbol.for("immer-nothing"),et=Symbol.for("immer-draftable"),T=Symbol.for("immer-state");function q(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var se=Object.getPrototypeOf;function ae(e){return!!e&&!!e[T]}function G(e){return e?bt(e)||Array.isArray(e)||!!e[et]||!!e.constructor?.[et]||pe(e)||Se(e):!1}var wa=Object.prototype.constructor.toString();function bt(e){if(!e||typeof e!="object")return!1;const t=se(e);if(t===null)return!0;const s=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return s===Object?!0:typeof s=="function"&&Function.toString.call(s)===wa}function ye(e,t){we(e)===0?Reflect.ownKeys(e).forEach(s=>{t(s,e[s],e)}):e.forEach((s,a)=>t(a,s,e))}function we(e){const t=e[T];return t?t.type_:Array.isArray(e)?1:pe(e)?2:Se(e)?3:0}function Re(e,t){return we(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function vt(e,t,s){const a=we(e);a===2?e.set(t,s):a===3?e.add(s):e[t]=s}function Sa(e,t){return e===t?e!==0||1/e===1/t:e!==e&&t!==t}function pe(e){return e instanceof Map}function Se(e){return e instanceof Set}function H(e){return e.copy_||e.base_}function Te(e,t){if(pe(e))return new Map(e);if(Se(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const s=bt(e);if(t===!0||t==="class_only"&&!s){const a=Object.getOwnPropertyDescriptors(e);delete a[T];let r=Reflect.ownKeys(a);for(let i=0;i<r.length;i++){const o=r[i],l=a[o];l.writable===!1&&(l.writable=!0,l.configurable=!0),(l.get||l.set)&&(a[o]={configurable:!0,writable:!0,enumerable:l.enumerable,value:e[o]})}return Object.create(se(e),a)}else{const a=se(e);if(a!==null&&s)return{...e};const r=Object.create(a);return Object.assign(r,e)}}function Be(e,t=!1){return _e(e)||ae(e)||!G(e)||(we(e)>1&&Object.defineProperties(e,{set:{value:fe},add:{value:fe},clear:{value:fe},delete:{value:fe}}),Object.freeze(e),t&&Object.values(e).forEach(s=>Be(s,!0))),e}function fe(){q(2)}function _e(e){return Object.isFrozen(e)}var _a={};function V(e){const t=_a[e];return t||q(0,e),t}var oe;function gt(){return oe}function Na(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function tt(e,t){t&&(V("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function Ae(e){qe(e),e.drafts_.forEach(Oa),e.drafts_=null}function qe(e){e===oe&&(oe=e.parent_)}function st(e){return oe=Na(oe,e)}function Oa(e){const t=e[T];t.type_===0||t.type_===1?t.revoke_():t.revoked_=!0}function at(e,t){t.unfinalizedDrafts_=t.drafts_.length;const s=t.drafts_[0];return e!==void 0&&e!==s?(s[T].modified_&&(Ae(t),q(4)),G(e)&&(e=be(t,e),t.parent_||ve(t,e)),t.patches_&&V("Patches").generateReplacementPatches_(s[T].base_,e,t.patches_,t.inversePatches_)):e=be(t,s,[]),Ae(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==yt?e:void 0}function be(e,t,s){if(_e(t))return t;const a=t[T];if(!a)return ye(t,(r,i)=>nt(e,a,t,r,i,s)),t;if(a.scope_!==e)return t;if(!a.modified_)return ve(e,a.base_,!0),a.base_;if(!a.finalized_){a.finalized_=!0,a.scope_.unfinalizedDrafts_--;const r=a.copy_;let i=r,o=!1;a.type_===3&&(i=new Set(r),r.clear(),o=!0),ye(i,(l,c)=>nt(e,a,r,l,c,s,o)),ve(e,r,!1),s&&e.patches_&&V("Patches").generatePatches_(a,s,e.patches_,e.inversePatches_)}return a.copy_}function nt(e,t,s,a,r,i,o){if(ae(r)){const l=i&&t&&t.type_!==3&&!Re(t.assigned_,a)?i.concat(a):void 0,c=be(e,r,l);if(vt(s,a,c),ae(c))e.canAutoFreeze_=!1;else return}else o&&s.add(r);if(G(r)&&!_e(r)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;be(e,r),(!t||!t.scope_.parent_)&&typeof a!="symbol"&&(pe(s)?s.has(a):Object.prototype.propertyIsEnumerable.call(s,a))&&ve(e,r)}}function ve(e,t,s=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&Be(t,s)}function Ea(e,t){const s=Array.isArray(e),a={type_:s?1:0,scope_:t?t.scope_:gt(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let r=a,i=We;s&&(r=[a],i=le);const{revoke:o,proxy:l}=Proxy.revocable(r,i);return a.draft_=l,a.revoke_=o,l}var We={get(e,t){if(t===T)return e;const s=H(e);if(!Re(s,t))return Ia(e,s,t);const a=s[t];return e.finalized_||!G(a)?a:a===Fe(e.base_,t)?(De(e),e.copy_[t]=Le(a,e)):a},has(e,t){return t in H(e)},ownKeys(e){return Reflect.ownKeys(H(e))},set(e,t,s){const a=jt(H(e),t);if(a?.set)return a.set.call(e.draft_,s),!0;if(!e.modified_){const r=Fe(H(e),t),i=r?.[T];if(i&&i.base_===s)return e.copy_[t]=s,e.assigned_[t]=!1,!0;if(Sa(s,r)&&(s!==void 0||Re(e.base_,t)))return!0;De(e),Ue(e)}return e.copy_[t]===s&&(s!==void 0||t in e.copy_)||Number.isNaN(s)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=s,e.assigned_[t]=!0),!0},deleteProperty(e,t){return Fe(e.base_,t)!==void 0||t in e.base_?(e.assigned_[t]=!1,De(e),Ue(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor(e,t){const s=H(e),a=Reflect.getOwnPropertyDescriptor(s,t);return a&&{writable:!0,configurable:e.type_!==1||t!=="length",enumerable:a.enumerable,value:s[t]}},defineProperty(){q(11)},getPrototypeOf(e){return se(e.base_)},setPrototypeOf(){q(12)}},le={};ye(We,(e,t)=>{le[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}});le.deleteProperty=function(e,t){return le.set.call(this,e,t,void 0)};le.set=function(e,t,s){return We.set.call(this,e[0],t,s,e[0])};function Fe(e,t){const s=e[T];return(s?H(s):e)[t]}function Ia(e,t,s){const a=jt(t,s);return a?"value"in a?a.value:a.get?.call(e.draft_):void 0}function jt(e,t){if(!(t in e))return;let s=se(e);for(;s;){const a=Object.getOwnPropertyDescriptor(s,t);if(a)return a;s=se(s)}}function Ue(e){e.modified_||(e.modified_=!0,e.parent_&&Ue(e.parent_))}function De(e){e.copy_||(e.copy_=Te(e.base_,e.scope_.immer_.useStrictShallowCopy_))}var Fa=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(t,s,a)=>{if(typeof t=="function"&&typeof s!="function"){const i=s;s=t;const o=this;return function(c=i,...f){return o.produce(c,d=>s.call(this,d,...f))}}typeof s!="function"&&q(6),a!==void 0&&typeof a!="function"&&q(7);let r;if(G(t)){const i=st(this),o=Le(t,void 0);let l=!0;try{r=s(o),l=!1}finally{l?Ae(i):qe(i)}return tt(i,a),at(r,i)}else if(!t||typeof t!="object"){if(r=s(t),r===void 0&&(r=t),r===yt&&(r=void 0),this.autoFreeze_&&Be(r,!0),a){const i=[],o=[];V("Patches").generateReplacementPatches_(t,r,i,o),a(i,o)}return r}else q(1,t)},this.produceWithPatches=(t,s)=>{if(typeof t=="function")return(o,...l)=>this.produceWithPatches(o,c=>t(c,...l));let a,r;return[this.produce(t,s,(o,l)=>{a=o,r=l}),a,r]},typeof e?.autoFreeze=="boolean"&&this.setAutoFreeze(e.autoFreeze),typeof e?.useStrictShallowCopy=="boolean"&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){G(e)||q(8),ae(e)&&(e=Da(e));const t=st(this),s=Le(e,void 0);return s[T].isManual_=!0,qe(t),s}finishDraft(e,t){const s=e&&e[T];(!s||!s.isManual_)&&q(9);const{scope_:a}=s;return tt(a,t),at(void 0,a)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let s;for(s=t.length-1;s>=0;s--){const r=t[s];if(r.path.length===0&&r.op==="replace"){e=r.value;break}}s>-1&&(t=t.slice(s+1));const a=V("Patches").applyPatches_;return ae(e)?a(e,t):this.produce(e,r=>a(r,t))}};function Le(e,t){const s=pe(e)?V("MapSet").proxyMap_(e,t):Se(e)?V("MapSet").proxySet_(e,t):Ea(e,t);return(t?t.scope_:gt()).drafts_.push(s),s}function Da(e){return ae(e)||q(10,e),wt(e)}function wt(e){if(!G(e)||_e(e))return e;const t=e[T];let s;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,s=Te(e,t.scope_.immer_.useStrictShallowCopy_)}else s=Te(e,!0);return ye(s,(a,r)=>{vt(s,a,wt(r))}),t&&(t.finalized_=!1),s}var Pa=new Fa,he=Pa.produce;class Ma{constructor(t){this.url=t}getDataToEdit(t,s,a,r){return this.request(`/${t}/get-data-to-edit/${a}/${r}`,"GET",Mt,ee(s),void 0,void 0)}getDataUseTermsHistory(t){return this.request(`/data-use-terms/${t}`,"GET",kt(Ct),void 0,void 0,void 0)}getSequences(t,s,a){return this.request(`/${s}/get-sequences`,"GET",$t,ee(t),void 0,a)}requestUpload(t,s,a){return this.request("/files/request-upload","POST",Rt,ee(t),void 0,{groupId:s,numberFiles:a})}async isInDebugMode(){return(await this.request("/","GET",Tt,void 0,void 0,void 0)).match(s=>s.isInDebugMode,()=>!1)}getPipelineStatistics(t){return this.request("/admin/pipeline-statistics","GET",At,ee(t),void 0,void 0)}async request(t,s,a,r,i,o){try{const l=await Dt.request({url:`${this.url}${t}`,method:s,headers:r,params:o,data:i}),c=a.safeParse(l.data);return c.success?ct(c.data):ke({type:"about:blank",title:"bad response",status:0,detail:`Failed to parse backend response: ${c.error.toString()}`})}catch(l){return ke({type:"about:blank",title:"bad response",status:0,detail:`Failed to make request: ${l.cause?.message}`})}}}const ka=(e,t)=>n.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",ref:t,...e,children:n.jsxs("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,children:[n.jsx("path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"}),n.jsx("path",{d:"M14 2v4a2 2 0 0 0 2 2h4"})]})}),Ca=h.forwardRef(ka),$a=(e,t)=>n.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",ref:t,...e,children:n.jsxs("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,children:[n.jsx("path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Zm-8-10v6"}),n.jsx("path",{d:"m9 13l3-3l3 3"})]})}),Ra=h.forwardRef($a),Ta=(e,t)=>n.jsx("svg",{viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",ref:t,...e,children:n.jsx("path",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 2v4m4.2 1.8l2.9-2.9M18 12h4m-5.8 4.2l2.9 2.9M12 18v4m-7.1-2.9l2.9-2.9M2 12h4M4.9 4.9l2.9 2.9"})}),Aa=h.forwardRef(Ta),qa=({fileCategory:e,inputMode:t,accessToken:s,clientConfig:a,group:r,setFileMapping:i,onError:o})=>{const l=qs(),[c,f]=h.useState(void 0),[d,m]=h.useState(!1),w=new Ma(a.backendUrl);function j(u){Object.entries(u).forEach(([y,x])=>{x.forEach(({file:g,url:v,fileId:_})=>{fetch(v,{method:"PUT",headers:{"Content-Type":g.type},body:g}).then(O=>{f(b=>b?.type==="uploadInProgress"?he(b,M=>{M.files[y]=b.files[y].map(E=>E.type==="pending"&&E.fileId===_?O.ok?{type:"uploaded",fileId:E.fileId,name:E.name,size:E.size}:{type:"error",msg:"error",name:E.name,size:E.size}:E)}):b)}).catch(O=>{O instanceof Error&&o(O.message)})})})}h.useEffect(()=>{if(c===void 0){i(u=>t==="bulk"?u!==void 0?he(u,y=>{Object.keys(y).forEach(x=>{y[x][e]=[]})}):void 0:he(u??{},y=>{y.dummySubmissionId={[e]:[]}}));return}switch(c.type){case"awaitingUrls":{const u=Object.values(c.files).map(y=>y.length).reduce((y,x)=>y+x);w.requestUpload(s,r.groupId,u).then(y=>{y.match(x=>{const g={};Object.keys(c.files).forEach(_=>g[_]=[]);let v=0;Object.entries(c.files).forEach(([_,O])=>{O.forEach(b=>{g[_].push({type:"pending",file:b.file,name:b.name,size:b.file.size,url:x[v].url,fileId:x[v].fileId}),v++})}),f({type:"uploadInProgress",files:g}),j(g)},x=>o(x.detail))}).catch(()=>o("failed to prepare upload."));break}case"uploadInProgress":{Object.values(c.files).flatMap(u=>u).every(({type:u})=>u==="uploaded")&&f({type:"uploadCompleted",files:c.files});break}case"uploadCompleted":{i(u=>he(u??{},y=>{Object.entries(c.files).forEach(([x,g])=>{u?.[x]!==void 0?y[x]={...u[x]}:y[x]={},y[x][e]=g})}));break}}},[c]);const p=u=>{if(u.target.files){const y=za(Array.from(u.target.files)),x=Ba(y,t);if(x){o(x);return}if(t==="form")f({type:"awaitingUrls",files:{dummySubmissionId:y.map(g=>({file:g,name:g.name}))}});else{const g=Object.fromEntries(y.map(v=>v.webkitRelativePath.split("/")).map(v=>[v[1],[]]));y.forEach(v=>{const _=v.webkitRelativePath.split("/")[1];g[_].push({file:v,name:v.name})}),f({type:"awaitingUrls",files:g})}}};return c===void 0||c.type==="awaitingUrls"?n.jsxs("div",{className:`flex flex-col items-center justify-center flex-1 py-2 px-4 border rounded-lg ${c!==void 0?"border-hidden":d?"border-dashed border-yellow-400 bg-yellow-50":"border-dashed border-gray-900/25"}`,onDragEnter:u=>{u.preventDefault(),u.stopPropagation(),m(!0)},onDragOver:u=>{u.preventDefault(),u.stopPropagation(),m(!0)},onDragLeave:u=>{u.preventDefault(),u.stopPropagation(),m(!1)},onDrop:u=>{u.preventDefault(),u.stopPropagation(),m(!1),dt.info("Sorry, drag and drop is not currently supported but you can select an entire folder to upload by clicking the Upload Folder button.")},children:[n.jsx(Ra,{className:"mx-auto mt-4 mb-2 h-12 w-12 text-gray-300","aria-hidden":"true"}),n.jsx("div",{children:c===void 0?n.jsxs("label",{className:"inline relative cursor-pointer rounded-md bg-white font-semibold text-primary-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-primary-600 focus-within:ring-offset-2 hover:text-primary-500",children:[n.jsx("span",{onClick:u=>{u.preventDefault(),document.getElementById(e)?.click()},children:"Upload Folder"}),l&&n.jsx("input",{id:e,name:e,type:"file",className:"sr-only","aria-label":`Upload ${e}`,"data-testid":e,onChange:p,webkitdirectory:"",directory:"",multiple:!0})]}):n.jsx("p",{children:"Preparing upload ..."})}),n.jsx("p",{className:"text-sm pt-2 leading-5 text-gray-600",children:"Upload an entire folder of files"})]}):n.jsxs("div",{className:"flex flex-col text-left px-4 py-3",children:[n.jsx("div",{className:"flex justify-between items-center mb-3",children:n.jsxs("div",{children:[n.jsx("h3",{className:"text-sm font-medium",children:"Files"}),t==="form"?Object.values(c.files)[0].map(u=>n.jsx(rt,{name:u.name,size:u.size,status:u.type},u.name)):Object.entries(c.files).flatMap(([u,y])=>[n.jsx("h4",{className:"text-xs font-medium py-2",children:u},u),...y.map(x=>n.jsx(rt,{name:x.name,size:x.size,status:x.type},x.name))]),n.jsx("ul",{})]})}),n.jsx("button",{onClick:()=>f(void 0),"data-testid":`discard_${e}`,className:"text-xs break-words text-gray-700 py-1.5 px-4 border border-gray-300 rounded-md hover:bg-gray-50",children:"Discard files"})]})},rt=({name:e,size:t,status:s})=>n.jsxs("div",{className:"flex flex-row",children:[n.jsx("div",{className:"w-3.5"}),n.jsx(Ca,{className:"h-4 w-4 text-gray-500 ml-1 mr-1"}),n.jsxs("div",{className:"flex-1 min-w-0 flex items-center",children:[n.jsx("span",{className:"text-xs text-gray-700 truncate max-w-[140px]",children:e}),n.jsxs("span",{className:"text-xs text-gray-400 ml-2 whitespace-nowrap",children:["(",Ua(t),")"]})]}),n.jsx("div",{className:"ml-2 w-5 flex justify-center",children:La(s)})]}),Ua=e=>{if(e<1024)return`${e} B`;const t=1024,s=["B","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(t)),r=parseFloat((e/Math.pow(t,a)).toFixed(2)),i=s[a];return`${r} ${i}`},La=e=>{switch(e){case"pending":return n.jsx(Aa,{className:"animate-spin h-3 w-3 text-blue-500"});case"uploaded":return n.jsx("span",{className:"text-green-500 text-xs",children:"✓"});case"error":return n.jsx("span",{className:"text-red-500 text-xs",children:"✗"})}},za=e=>e.filter(t=>t.webkitRelativePath.split("/").every(a=>!a.startsWith("."))),Ba=(e,t)=>{if(e.map(r=>r.webkitRelativePath.split("/")).filter(r=>r.length>(t==="form"?2:3)).map(r=>r[r.length-2]).length>0)return"Subdirectories are not yet supported.";const a=e.map(r=>r.webkitRelativePath.split("/")).filter(r=>r.length<(t==="form"?2:3)).map(r=>r[r.length-1]);if(a.length>0)return`All files need to be inside a directory named with a sequence ID; these files are not: ${a.join(", ")}`},St=e=>ot.now().plus({months:e}),Wa=As("DataUploadForm"),Ka=({accessToken:e,organism:t,clientConfig:s,action:a,inputMode:r,onSuccess:i,onError:o,group:l,referenceGenomeSequenceNames:c,metadataTemplateFields:f,submissionDataTypes:d,dataUseTermsEnabled:m})=>{const w=d.files?.enabled??!1,{submit:j,revise:p,isLoading:u}=Xa(e,t,s,i,o),[y,x]=h.useState(void 0),[g,v]=h.useState(void 0),[_,O]=h.useState(Pe),[b,M]=h.useState(St(6)),[E,I]=h.useState(!1),[$,S]=h.useState(!1),L=async z=>{z.preventDefault();const B=await y();if(B.type==="error"){o(B.errorMessage);return}const{metadataFile:X,sequenceFile:Y,submissionId:W}=B;if(W===void 0&&r==="form"){o("No ID specified.");return}if(m&&!$){o("Please confirm the data you submitted does not include restricted or personally identifiable information.");return}if(m&&!E){o("Please tick the box to agree that you will not independently submit these sequences to INSDC");return}let K=g;w&&r==="form"&&g!==void 0&&(K={[W]:Object.values(g)[0]});const J=()=>{switch(a){case"submit":{const ne=l.groupId;j({metadataFile:X,sequenceFile:Y,fileMapping:w?K:void 0,groupId:ne,dataUseTermsType:_,restrictedUntil:_===lt?b.toFormat("yyyy-MM-dd"):null});break}case"revise":p({metadataFile:X,sequenceFile:Y});break}};a==="submit"&&m&&_===Pe?Ws({dialogText:"You have selected the Open Data Use Terms. Once released under the Open Data Use Terms sequences will be deposited to INSDC and cannot be changed to the Restricted-Use Data Use Terms.",confirmButtonText:"Continue under Open terms",closeButtonText:"Cancel",onConfirmation:J}):J()};return n.jsx("div",{className:"text-left mt-3 max-w-4xl mb-3",children:n.jsxs("div",{className:"flex-col flex gap-8",children:[a==="submit"?n.jsxs(n.Fragment,{children:[n.jsx("h1",{className:"title",children:"Submit sequences"}),n.jsx(Ha,{organism:t,groupId:l.groupId,currentInputMode:r}),n.jsx(Ze,{inputMode:r,setFileFactory:x,organism:t,action:a,referenceGenomeSequenceNames:c,metadataTemplateFields:f,submissionDataTypes:d})]}):n.jsx(Ze,{inputMode:"bulk",setFileFactory:x,organism:t,action:a,referenceGenomeSequenceNames:c,metadataTemplateFields:f,submissionDataTypes:d}),n.jsx("hr",{}),w&&n.jsxs(n.Fragment,{children:[n.jsx(Qa,{fileCategories:d.files?.categories??[],accessToken:e,inputMode:r,clientConfig:s,group:l,onError:o,setFileMapping:v}),n.jsx("hr",{})]}),a==="submit"&&m&&n.jsxs(n.Fragment,{children:[n.jsx(Ga,{dataUseTermsType:_,setDataUseTermsType:O,restrictedUntil:b,setRestrictedUntil:M}),n.jsx("hr",{})]}),m&&n.jsxs(n.Fragment,{children:[n.jsx(Va,{confirmedNoPII:$,setConfirmedNoPII:S,agreedToINSDCUploadTerms:E,setAgreedToINSDCUploadTerms:I}),n.jsx("hr",{})]}),n.jsx("div",{className:"flex justify-end gap-x-6",children:n.jsx(Ks,{alsoDisabledIf:u,children:n.jsxs("button",{name:"submit",type:"submit",className:"rounded-md py-2 text-sm font-semibold shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 bg-primary-600 text-white hover:bg-primary-500",onClick:z=>void L(z),children:[n.jsx("div",{className:`absolute ml-1.5 inline-flex ${u?"visible":"invisible"}`,children:n.jsx("span",{className:"loading loading-spinner loading-sm"})}),n.jsx("span",{className:"flex-1 text-center mx-8",children:"Submit sequences"})]})})})]})})},jn=Hs(Ka),Ha=({organism:e,groupId:t,currentInputMode:s})=>{const a=r=>Ls.toUrl({name:"submit",organism:e,groupId:t,inputMode:r});return n.jsxs("div",{className:"flex border-b",children:[n.jsx("a",{className:`py-2 px-4 border-b-2 ${s==="bulk"?"border-primary-600 text-primary-600":"border-transparent text-gray-500"} hover:text-primary-600`,href:a("bulk"),children:"Upload bulk sequences"}),n.jsx("a",{className:`py-2 px-4 border-b-2 ${s==="form"?"border-primary-600 text-primary-600":"border-transparent text-gray-500"} hover:text-primary-600`,href:a("form"),children:"Submit single sequence"})]})},Qa=({accessToken:e,clientConfig:t,inputMode:s,group:a,fileCategories:r,setFileMapping:i,onError:o})=>n.jsxs("div",{className:"grid sm:grid-cols-3 gap-x-16 gap-y-4",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"font-medium text-lg",children:"Extra files"}),n.jsx("p",{className:"text-gray-500 text-sm",children:s==="bulk"?"The folder you select needs to contain one folder per sequence ID, which contains the files for that sequence entry":"Upload a folder of files for this sequence"})]}),n.jsx("div",{className:"col-span-2 flex flex-col gap-4",children:r.map(l=>n.jsx(qa,{fileCategory:l.name,inputMode:s,accessToken:e,clientConfig:t,group:a,onError:o,setFileMapping:i},l.name))})]}),Ga=({dataUseTermsType:e,setDataUseTermsType:t,restrictedUntil:s,setRestrictedUntil:a})=>n.jsxs("div",{className:"grid sm:grid-cols-3 gap-x-16 gap-y-4",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"font-medium text-lg",children:"Data use terms"}),n.jsx("p",{className:"text-gray-500 text-sm",children:"Choose how your data can be used"})]}),n.jsx("div",{className:"gap-x-6 gap-y-8 col-span-2",children:n.jsxs("div",{className:"space-y-6",children:[n.jsx("label",{htmlFor:"username",className:"block text-sm font-medium leading-6 text-gray-900",children:"Terms of use for this data set"}),n.jsx("div",{className:"space-y-2",children:n.jsx(Us,{calendarUseModal:!0,initialDataUseTermsOption:e,maxRestrictedUntil:St(12),setDataUseTerms:r=>{t(r.type),r.type===lt&&a(ot.fromFormat(r.restrictedUntil,"yyyy-MM-dd"))}})}),e===Pe?n.jsx("p",{className:"text-sm",children:"Your data will be available on Pathoplexus under the open use terms."}):n.jsxs("p",{className:"text-sm",children:["Your data will be available on Pathoplexus, under the restricted use terms until"," ",s.toFormat("yyyy-MM-dd")," and under the open use terms after that date."]})]})})]}),Va=({confirmedNoPII:e,setConfirmedNoPII:t,agreedToINSDCUploadTerms:s,setAgreedToINSDCUploadTerms:a})=>n.jsxs("div",{className:"grid sm:grid-cols-3 gap-x-16 gap-y-4",children:[n.jsxs("div",{className:"",children:[n.jsx("h2",{className:"font-medium text-lg",children:"Acknowledgement"}),n.jsx("p",{className:"text-gray-500 text-sm",children:"Acknowledge submission terms"})]}),n.jsx("div",{className:"gap-x-6 gap-y-8 col-span-2",children:n.jsxs("div",{children:[n.jsxs("p",{className:"block text-sm",children:["Your data will be available on Pathoplexus, under the selected data use terms. Data with open data use terms will additionally be made publicly available through the"," ",n.jsx("a",{href:"https://www.insdc.org/",className:"text-primary-600 hover:underline",children:"INSDC"})," ","databases (ENA, DDBJ, NCBI)."]}),n.jsx("div",{className:"mt-2 py-5",children:n.jsxs("label",{className:"flex items-center",children:[n.jsx("input",{type:"checkbox",name:"confirmation-no-pii",className:"mr-3 ml-1 h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-600",checked:e,onChange:()=>t(!e)}),n.jsx("div",{children:n.jsx("p",{className:"text-xs pl-4 text-gray-500",children:"I confirm that the data submitted is not sensitive or human-identifiable"})})]})}),n.jsx("div",{className:"mb-4 py-3",children:n.jsxs("label",{className:"flex items-center",children:[n.jsx("input",{type:"checkbox",name:"confirmation-INSDC-upload-terms",className:"mr-3 ml-1 h-5 w-5 rounded border-gray-300 text-primary-600 focus:ring-primary-600",checked:s,onChange:()=>a(!s)}),n.jsx("div",{children:n.jsxs("p",{className:"text-xs pl-4 text-gray-500",children:["I confirm I have not and will not submit this data independently to INSDC, to avoid data duplication. I agree to Loculus handling the submission of this data to INSDC."," ",n.jsx("a",{href:"/docs/concepts/insdc-submission",className:"text-primary-600 hover:underline",children:"Find out more."})]})})]})})]})})]});function Xa(e,t,s,a,r){const i=zs(s),o=i.useSubmit({params:{organism:t},headers:ee(e)},{onSuccess:a,onError:it(r,"submit")}),l=i.useRevise({params:{organism:t},headers:ee(e)},{onSuccess:a,onError:it(r,"revise")});return{submit:o.mutate,revise:l.mutate,isLoading:o.isLoading||l.isLoading}}function it(e,t){return s=>{if(Wa.error(`Received error from backend: ${Xe(s)}`),Pt(Bs,t,s))switch(s.response.status){case 400:e("Failed to submit sequence entries: "+s.response.data.detail);return;case 422:e("The submitted file content was invalid: "+s.response.data.detail);return;default:e(s.response.data.title+": "+s.response.data.detail);return}e("Received unexpected message from backend: "+Xe(s))}}export{jn as D};
