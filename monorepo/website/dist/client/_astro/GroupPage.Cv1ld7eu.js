import{j as e}from"./jsx-runtime.C9E4cUVc.js";import{u as S,a as U}from"./createAuthorizationHeader.D0lXW5f5.js";import{r as x}from"./index.BOC3FD3Q.js";import{b as k}from"./useGroupOperations.lH_AAz-u.js";import{r as c}from"./routes.B4evqrXf.js";import{G as I,I as L,V as q}from"./settings.CpUHmJUd.js";import{v as A}from"./lapis.BMBLPoxt.js";import"./runtimeConfig.CVbULwPe.js";import{d as N}from"./ConfirmationDialog.DES7BW3S.js";import{D as p}from"./DisabledUntilHydrated.BWqRU456.js";import{ErrorFeedback as M}from"./ErrorFeedback.C-rFFzT8.js";import{w as G}from"./withQueryProvider.C5jGp74p.js";import{F as v}from"./groups.BhMEaWi0.js";import{F as T}from"./arrow-down.B8IS15yr.js";import"./stringifyMaybeAxiosError.Dyiug7p6.js";import"./SubmissionRoute.C0UznQB_.js";import"./index.B4z6aONy.js";import"./client.DPyJZckk.js";import"./index.BDobkqVR.js";import"./isClient.CwQyaCl4.js";import"./useTheme.DwRJctbP.js";import"./utils.CJHPicf9.js";import"./index.CExoqQxK.js";import"./clsx.B-dksMZM.js";import"./ButtonBase.BnBxMrJ6.js";const D=(r,a)=>e.jsx("svg",{viewBox:"0 0 20 20",width:"1.2em",height:"1.2em",ref:a,...r,children:e.jsx("path",{fill:"currentColor",d:"M17 7v3h-5v5H9v-5H4V7h5V2h3v5z"})}),O=x.forwardRef(D),V=({prefetchedGroupDetails:r,clientConfig:a,accessToken:u,username:o,userGroups:t,organisms:n,databaseName:h})=>{const i=r.group.groupName,m=r.group.groupId,[g,j]=x.useState(""),[b,f]=x.useState(void 0),{groupDetails:l,removeFromGroup:w,addUserToGroup:C}=k({clientConfig:a,accessToken:u,setErrorMessage:f,prefetchedGroupDetails:r}),E=async s=>{s.preventDefault(),await C(g),j("")},F=l.data?.users.some(s=>s.name===o)??!1,y=t.some(s=>s.groupId===r.group.groupId),{data:P,isLoading:$}=S({queryKey:["group-sequence-counts",m,a,n],queryFn:()=>_(m,a,n)});return e.jsxs("div",{className:"flex flex-col h-full p-4",children:[b!==void 0&&e.jsx(M,{message:b,onClose:()=>f(void 0)}),y?e.jsxs("div",{className:"flex items-center",children:[e.jsxs("h1",{className:"flex flex-row gap-4 title flex-grow",children:[e.jsx("label",{className:"mt-1.5",children:e.jsx(v,{})}),e.jsxs("div",{className:"dropdown dropdown-hover hidden sm:flex relative",children:[e.jsxs("label",{tabIndex:0,className:"py-1 block cursor-pointer title",children:[i,e.jsx("span",{className:"text-primary",children:e.jsx(T,{className:"inline-block -mt-1 ml-1 h-4 w-4 "})})]}),e.jsxs("ul",{tabIndex:0,className:"dropdown-content z-[1] menu p-1 shadow bg-base-100 rounded-btn absolute top-full -left-4 min-w-60",children:[t.map(s=>s.groupId!==r.group.groupId&&e.jsx("li",{children:e.jsxs("a",{href:c.groupOverviewPage(s.groupId),children:[e.jsx(v,{className:"w-6 h-6 inline-block mr-2"}),s.groupName]})},s.groupId)),e.jsx("li",{children:e.jsxs("a",{href:c.createGroup(),children:[e.jsx(O,{className:"w-6 h-6 inline-block mr-2"}),"Create a new group..."]})})]})]})]}),F&&e.jsxs(e.Fragment,{children:[e.jsx("a",{href:c.editGroupPage(m),className:"object-right p-2 loculusColor text-white rounded px-4 mr-2",children:"Edit group"}),e.jsx(p,{children:e.jsx("button",{className:"object-right p-2 loculusColor text-white rounded px-4",onClick:()=>{const R=`${(l.data?.users.length??0)<=1?"You are the last user in this group. Leaving will leave the group without any members, meaning that nobody is able to add future members. ":""}Are you sure you want to leave the ${i} group?`;N({dialogText:R,onConfirmation:async()=>{await w(o),window.location.href=c.userOverviewPage()}})},children:"Leave group"})})]})]}):e.jsxs("h1",{className:"flex flex-row gap-4 title flex-grow",children:[e.jsx("label",{className:"block title",children:"Group:"}),i]}),e.jsx("div",{className:" max-w-2xl mx-auto px-10 py-4 bg-gray-100 rounded-md my-4",children:e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[e.jsx(d,{label:"Group ID",children:l.data?.group.groupId}),e.jsx(d,{label:"Institution",children:l.data?.group.institution}),e.jsx(d,{label:"Contact email",children:l.data?.group.contactEmail}),e.jsx(d,{label:"Address",children:e.jsx(H,{address:l.data?.group.address})})]})})}),e.jsxs("div",{className:" max-w-2xl mx-auto px-10 py-4 bg-gray-100 rounded-md my-4",children:[e.jsxs("h2",{className:"text-lg font-bold mb-2",children:["Sequences available in ",h]}),e.jsx("table",{className:"w-full",children:e.jsx("tbody",{children:n.map(s=>e.jsx(d,{label:s.displayName,children:$?e.jsx("span",{className:"loading loading-spinner loading-xs"}):e.jsx("a",{href:`${c.searchPage(s.key)}?${I}=${m}`,className:"underline",children:P?.[s.key]??0})},s.key))})})]}),y&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-lg font-bold py-4",children:" Users "}),e.jsx("form",{onSubmit:s=>void E(s),children:e.jsxs("div",{className:"flex mb-4",children:[e.jsx("input",{type:"text",value:g,onChange:s=>j(s.target.value.trim()),placeholder:"Enter new user name",className:"p-2 border border-gray-300 rounded mr-2",required:!0}),e.jsx(p,{children:e.jsx("button",{type:"submit",className:"px-4 py-2 loculusColor text-white rounded",children:"Add user"})})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsx("ul",{children:l.data?.users.map(s=>e.jsxs("li",{className:"flex items-center gap-6 bg-gray-100 p-2 mb-2 rounded",children:[e.jsx("span",{className:"text-lg",children:s.name}),s.name!==o&&e.jsx(p,{children:e.jsx("button",{onClick:()=>{N({dialogText:`Are you sure you want to remove ${s.name} from the group ${i}?`,onConfirmation:async()=>{await w(s.name)}})},className:"px-2 py-1 loculusColor text-white rounded",title:"Remove user from group","aria-label":`Remove User ${s.name}`,children:"Remove user"})})]},s.name))})})]})]})};async function _(r,a,u){const o={};return await Promise.all(u.map(async({key:t})=>{const n=a.lapisUrls[t];if(!n){o[t]=0;return}try{const i=(await U.post(`${n}/sample/aggregated`,{[I]:r,[q]:A.latestVersion,[L]:"false",fields:[]})).data.data?.[0]?.count??0;o[t]=i}catch{o[t]=0}})),o}const je=G(V),H=({address:r})=>r===void 0?"":e.jsxs("div",{children:[r.line1," ",e.jsx("br",{}),r.line2!==""?`${r.line2}`:null,r.line2!==""?e.jsx("br",{}):null," ",r.postalCode," ",r.city," ",e.jsx("br",{}),r.state!==""?`${r.state}`:null,r.state!==""?e.jsx("br",{}):null,r.country]}),d=({label:r,children:a})=>e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("td",{className:"py-2 pr-4 text-right align-top",children:e.jsx("span",{className:"text-lg font-semibold text-gray-800",children:r})}),e.jsx("td",{className:"py-2 pl-4",children:e.jsx("span",{className:"text-lg text-gray-900",children:a})})]});export{je as GroupPage};
