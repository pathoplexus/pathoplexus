name: broken-link-check
on:
  workflow_dispatch:
    inputs:
      custom_subdomain:
        description: 'Custom subdomain for link checking'
        required: false
        type: string
  push:
    paths:
      - .github/workflows/periodic-broken-link-checks.yml
    branches:
      - main
  schedule:
    - cron: '9 9 * * *'
jobs:
  broken-link-checker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set URL
        id: set-url
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.custom_subdomain }}" ]]; then
            echo "url=https://${{ github.event.inputs.custom_subdomain }}.pathoplexus.org" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "url=https://preview-${GITHUB_REF##*/}.pathoplexus.org" >> $GITHUB_OUTPUT
          else
            echo "url=https://pathoplexus.org" >> $GITHUB_OUTPUT
          fi
      - name: Check broken links
        uses: ruzickap/action-my-broken-link-checker@v2
        with:
          url: ${{ steps.set-url.outputs.url }}
          cmd_params: '--buffer-size=8192 --max-connections=10 --color=always --header="User-Agent:curl/7.54.0" --timeout=20'
