name: broken-link-check
on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]
  workflow_dispatch:
    inputs:
      custom_subdomain:
        description: 'Custom subdomain for link checking'
        required: false
        type: string
  push:
    branches:
      - main
  schedule:
    - cron: '9 9 * * *'
jobs:
  check-preview-label:
    runs-on: ubuntu-latest
    outputs:
      has-preview-label: ${{ steps.check-label.outputs.has-preview-label }}
    steps:
      - name: Check for preview label
        id: check-label
        if: github.event_name == 'pull_request'
        run: |
          if [[ ${{ contains(github.event.pull_request.labels.*.name, 'preview') }} == 'true' ]]; then
            echo "has-preview-label=true" >> $GITHUB_OUTPUT
          else
            echo "has-preview-label=false" >> $GITHUB_OUTPUT
          fi
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "matrix={\"subdomain\":[\"preview-main\",\"preview-staging\",\"preview-demo\",\"\"]}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.custom_subdomain }}" ]]; then
            echo "matrix={\"subdomain\":[\"${{ github.event.inputs.custom_subdomain }}\"]}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "matrix={\"subdomain\":[\"preview-${{ github.ref_name }}\"]}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "matrix={\"subdomain\":[\"preview-${{ github.head_ref }}\"]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"subdomain\":[\"\"]}" >> $GITHUB_OUTPUT
          fi
  broken-link-checker:
    needs: [check-preview-label, generate-matrix]
    if: >
      github.event_name != 'pull_request' || (github.event_name == 'pull_request' && needs.check-preview-label.outputs.has-preview-label == 'true')

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.generate-matrix.outputs.matrix)}}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set URL
        id: set-url
        run: |
          if [[ -z "${{ matrix.subdomain }}" ]]; then
            echo "url=https://pathoplexus.org" >> $GITHUB_OUTPUT
          else
            echo "url=https://${{ matrix.subdomain }}.pathoplexus.org" >> $GITHUB_OUTPUT
          fi
      - name: Check broken links
        uses: ruzickap/action-my-broken-link-checker@v2
        with:
          url: ${{ steps.set-url.outputs.url }}
          cmd_params: '--buffer-size=8192 --max-connections=10 --color=always --header="User-Agent:curl/7.54.0" --timeout=20'
